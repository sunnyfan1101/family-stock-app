name: æ¯æ—¥è‚¡åƒ¹è‡ªå‹•æ›´æ–°

on:
  schedule:
    # æ¯å¤© UTC 07:15 (å°ç£æ™‚é–“ 15:15) åŸ·è¡Œ
    - cron: '15 7 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: ä¸‹è¼‰ç¨‹å¼ç¢¼ (Checkout)
      uses: actions/checkout@v3

    - name: è¨­å®š Python ç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: å®‰è£å¥—ä»¶
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # â˜… ä¿®æ”¹ 1ï¼šç”¨ Python ä¸€è¡ŒæŒ‡ä»¤è§£å£“ç¸® .xz (æ¯”å®‰è£ xz-utils æ›´å¿«æ›´ç©©)
    - name: è§£å£“ç¸®è³‡æ–™åº« (Decompress .xz)
      run: |
        python -c "import lzma, shutil; shutil.copyfileobj(lzma.open('stock_data.db.xz', 'rb'), open('stock_data.db', 'wb'))" 2>/dev/null || echo "åˆæ¬¡åŸ·è¡Œæˆ–ç„¡å£“ç¸®æª”"

    # â˜… ä¿®æ”¹ 2ï¼šåŸ·è¡Œ Python (å®ƒç¾åœ¨æœƒæ›´æ–° -> ç˜¦èº« -> å£“ç¸®æˆ .xz)
    - name: åŸ·è¡Œæ›´æ–°èˆ‡å£“ç¸® (Update & Compress)
      env: 
        PYTHONIOENCODING: utf-8
      run: |
        python fetch_data.py

    # â˜… ä¿®æ”¹ 3ï¼šåªä¸Šå‚³ .xz æª”
    - name: å­˜æª”ä¸¦ä¸Šå‚³ (Commit & Push)
      run: |
        git config --global user.name "GitHub Action Bot"
        git config --global user.email "action@github.com"
        
        # åŠ å…¥ .xz æª”
        git add stock_data.db.xz
        
        
        git commit -m "ğŸ“ˆ è‡ªå‹•æ›´æ–°è‚¡åƒ¹ (5å¹´/LZMA): $(date +'%Y-%m-%d')" || echo "ç„¡è³‡æ–™è®Šå‹•"
        git push