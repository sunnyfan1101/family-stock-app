name: æ¯æ—¥è‚¡åƒ¹è‡ªå‹•æ›´æ–°

on:
  schedule:
    # æ¯å¤© UTC 07:15 (å°ç£æ™‚é–“ 15:15)
    # èªªæ˜ï¼šCron èªæ³•æœ€å¾Œä¸€ç¢¼æ˜¯æ˜ŸæœŸ (0=é€±æ—¥, 1=é€±ä¸€... 6=é€±å…­)
    # æ”¹æˆ '1-5' ä»£è¡¨åªåœ¨ é€±ä¸€åˆ°é€±äº” åŸ·è¡Œï¼Œé¿é–‹é€±æœ«å ±éŒ¯
    - cron: '15 7 * * 1-5'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: ä¸‹è¼‰ç¨‹å¼ç¢¼ (Checkout)
      uses: actions/checkout@v3

    - name: è¨­å®š Python ç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: å®‰è£å¥—ä»¶
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: è§£å£“ç¸®è³‡æ–™åº« (Decompress .xz)
      run: |
        python -c "import lzma, shutil; shutil.copyfileobj(lzma.open('stock_data.db.xz', 'rb'), open('stock_data.db', 'wb'))" 2>/dev/null || echo "åˆæ¬¡åŸ·è¡Œæˆ–ç„¡å£“ç¸®æª”"

    - name: åŸ·è¡Œæ›´æ–°èˆ‡å£“ç¸® (Update & Compress)
      env: 
        PYTHONIOENCODING: utf-8
      run: |
        python fetch_data.py

    - name: å­˜æª”ä¸¦ä¸Šå‚³ (Commit & Push)
      run: |
        git config --global user.name "GitHub Action Bot"
        git config --global user.email "action@github.com"
        
        # åŠ å…¥ .xz æª”
        git add stock_data.db.xz
        
        # å¦‚æœæ²’æœ‰è®Šæ›´ (ä¾‹å¦‚è£œç­æ—¥è‚¡å¸‚æ²’é–‹)ï¼Œä¸å ±éŒ¯
        git commit -m "ğŸ“ˆ è‡ªå‹•æ›´æ–°è‚¡åƒ¹ (5å¹´/LZMA): $(date +'%Y-%m-%d')" || echo "ç„¡è³‡æ–™è®Šå‹•"
        git push